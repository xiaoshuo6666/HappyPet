<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Pet - è¨Šæ¯ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root {
            --primary: #8a6db5;
            --primary-dark: #6b4e8e;
            --primary-light: #b8a2d4;
            --secondary: #ff9a76;
            --light: #f8f4ff;
            --lighter: #fefbff;
            --dark: #5a4a6a;
            --gray: #e0e0e0;
            --gray-light: #f5f5f5;
            --gray-dark: #9e9e9e;
            --success: #4caf50;
            --online: #4caf50;
            --offline: #9e9e9e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8f4ff 0%, #f0e6ff 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding-top: 80px;
        }

        /* å¯¼èˆªæ æ ·å¼ - ä¸ä¸»ç«™ä¸€è‡´ */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(107, 78, 142, 0.3);
            z-index: 1000;
        }

        .navbar-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-logo {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
        }

        .navbar-logo i {
            margin-right: 12px;
        }

        /* èŠå¤©å®¹å™¨ */
        .chat-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(107, 78, 142, 0.15);
            overflow: hidden;
            height: calc(100vh - 120px);
            display: flex;
        }

        /* ä¼šè¯åˆ—è¡¨ */
        .sessions-sidebar {
            width: 350px;
            border-right: 1px solid var(--gray);
            background: var(--lighter);
            display: flex;
            flex-direction: column;
        }

        .sessions-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray);
            background: white;
        }

        .sessions-header h2 {
            color: var(--primary-dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 1px solid var(--gray);
            border-radius: 25px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(138, 109, 181, 0.2);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-dark);
        }

        .sessions-list {
            flex: 1;
            overflow-y: auto;
        }

        .session-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .session-item:hover {
            background: var(--light);
        }

        .session-item.active {
            background: var(--primary-light);
            border-left: 4px solid var(--primary);
        }

        .session-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            position: relative;
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--online);
            border: 2px solid white;
        }

        .offline .online-indicator {
            background: var(--offline);
        }

        .session-info {
            flex: 1;
            min-width: 0;
        }

        .session-name {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-preview {
            font-size: 0.85rem;
            color: var(--gray-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-meta {
            text-align: right;
        }

        .session-time {
            font-size: 0.8rem;
            color: var(--gray-dark);
            margin-bottom: 5px;
        }

        .unread-badge {
            background: var(--primary);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray);
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-partner-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-partner-name {
            font-weight: 600;
            color: var(--dark);
        }

        .chat-status {
            font-size: 0.85rem;
            color: var(--gray-dark);
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--gray-dark);
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: var(--gray-light);
            color: var(--dark);
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--lighter);
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            align-self: flex-start;
            background: white;
            color: var(--dark);
            border: 1px solid var(--gray);
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 0.75rem;
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        .message-file {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-top: 5px;
        }

        .message.received .message-file {
            background: var(--gray-light);
        }

        .file-icon {
            font-size: 1.5rem;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .file-size {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 20px;
            border-top: 1px solid var(--gray);
            background: white;
        }

        .message-input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-actions {
            display: flex;
            gap: 5px;
        }

        .input-action-btn {
            background: none;
            border: none;
            color: var(--gray-dark);
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: all 0.3s;
            font-size: 1.2rem;
        }

        .input-action-btn:hover {
            color: var(--primary);
            background: var(--light);
        }

        .message-input {
            flex: 1;
            border: 1px solid var(--gray);
            border-radius: 25px;
            padding: 12px 20px;
            resize: none;
            max-height: 120px;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-dark);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--gray);
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--dark);
        }

        /* æ–‡ä»¶ä¸Šä¼ é¢„è§ˆ */
        .file-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .file-preview-remove {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 5px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 100px);
            }

            .sessions-sidebar {
                width: 100%;
                display: none;
            }

            .sessions-sidebar.active {
                display: flex;
            }

            .chat-area {
                display: none;
            }

            .chat-area.active {
                display: flex;
            }

            .mobile-toggle {
                display: block;
            }
        }

        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.2rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-logo">
                <i class="fas fa-paw"></i> HAPPY PET - è¨Šæ¯ä¸­å¿ƒ
            </div>
            <div class="navbar-buttons">
                <button class="navbar-btn" onclick="location.href='index.html'">
                    <i class="fas fa-home"></i> è¿”å›é¦–é 
                </button>
            </div>
        </div>
    </nav>

    <!-- èŠå¤©å®¹å™¨ -->
    <div class="chat-container">
        <!-- ä¼šè¯åˆ—è¡¨ä¾§è¾¹æ  -->
        <div class="sessions-sidebar" id="sessionsSidebar">
            <div class="sessions-header">
                <h2><i class="fas fa-comments"></i> è¨Šæ¯åˆ—è¡¨</h2>
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="æœå°‹å°è©±..." id="searchSessions">
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            <div class="sessions-list" id="sessionsList">
                <!-- ä¼šè¯åˆ—è¡¨ä¼šåŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="chat-area" id="chatArea">
            <div class="chat-header">
                <div class="chat-partner-info" id="chatPartnerInfo">
                    <div class="session-avatar" id="partnerAvatar">
                        <i class="fas fa-user"></i>
                        <div class="online-indicator" id="partnerStatus"></div>
                    </div>
                    <div>
                        <div class="chat-partner-name" id="partnerName">é¸æ“‡å°è©±é–‹å§‹èŠå¤©</div>
                        <div class="chat-status" id="partnerStatusText">é›¢ç·š</div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="action-btn mobile-toggle" id="toggleSessions">
                        <i class="fas fa-bars"></i>
                    </button>
                    <button class="action-btn" id="chatInfoBtn">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="empty-state" id="emptyChatState">
                    <i class="fas fa-comment-dots"></i>
                    <h3>é–‹å§‹å°è©±</h3>
                    <p>é¸æ“‡å·¦å´çš„å°è©±æˆ–é–‹å§‹æ–°çš„å°è©±</p>
                </div>
                <!-- æ¶ˆæ¯ä¼šåŠ¨æ€åŠ è½½ -->
            </div>

            <div class="input-area" id="inputArea" style="display: none;">
                <div class="file-preview" id="filePreview" style="display: none;"></div>
                <div class="message-input-container">
                    <div class="input-actions">
                        <button class="input-action-btn" id="attachFileBtn">
                            <i class="fas fa-paperclip"></i>
                            <input type="file" id="fileInput" style="display: none;" accept="image/*,application/pdf,.doc,.docx">
                        </button>
                        <button class="input-action-btn" id="emojiBtn">
                            <i class="fas fa-smile"></i>
                        </button>
                    </div>
                    <textarea class="message-input" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯..." rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
       // API åŸºç¤ç¶²å€
        const API_BASE_URL = 'http://localhost:3000/api';
        
        // å…¨å±€è®Šé‡
        let socket = null;
        let currentUser = null;
        let currentSession = null;
        let sessions = [];
        let fileToSend = null;

        // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”„ åˆå§‹åŒ–èŠå¤©ç³»çµ±...');
            
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                alert('è«‹å…ˆç™»å…¥');
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = JSON.parse(user);
            initializeChat();
        });

        // ä¿®å¾©çš„åˆå§‹åŒ–å‡½æ•¸
        async function initializeChat() {
            try {
                console.log('ğŸ”Œ å˜—è©¦é€£æ¥ Socket.io...');
                
                // é€£æ¥ Socket.io - ä¿®å¾©ç‰ˆæœ¬
                socket = io('http://localhost:3000', {
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    reconnectionAttempts: 10,
                    reconnectionDelay: 1000,
                    forceNew: true
                });
                
                // Socket.io äº‹ä»¶ç›£è½
                socket.on('connect', () => {
                    console.log('âœ… å·²é€£æ¥åˆ°èŠå¤©ä¼ºæœå™¨ï¼Œé€£æ¥æ–¹å¼:', socket.io.engine.transport.name);
                    console.log('ğŸ”— Socket ID:', socket.id);
                    
                    // é€šçŸ¥æœå‹™å™¨ç”¨æˆ¶ä¸Šç·š
                    socket.emit('user_online', currentUser.id);
                    
                    // é¡¯ç¤ºé€£æ¥ç‹€æ…‹
                    updateConnectionStatus('connected');
                });
                
                socket.on('new_message', handleNewMessage);
                socket.on('messages_read', handleMessagesRead);
                socket.on('user_status_changed', handleUserStatusChanged);
                
                socket.on('disconnect', (reason) => {
                    console.log('âŒ èˆ‡èŠå¤©ä¼ºæœå™¨æ–·é–‹é€£æ¥ï¼ŒåŸå› :', reason);
                    updateConnectionStatus('disconnected');
                });

                socket.on('connect_error', (error) => {
                    console.error('âŒ Socket.io é€£æ¥éŒ¯èª¤:', error.message);
                    console.error('éŒ¯èª¤è©³æƒ…:', error);
                    updateConnectionStatus('error');
                    
                    // é¡¯ç¤ºç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤ä¿¡æ¯
                    if (error.message.includes('websocket error')) {
                        console.log('âš ï¸ WebSocket é€£æ¥å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨è¼ªè©¢æ–¹å¼');
                    }
                });

                socket.on('reconnect_attempt', (attempt) => {
                    console.log(`ğŸ”„ é‡æ–°é€£æ¥å˜—è©¦: ${attempt}`);
                    updateConnectionStatus('reconnecting');
                });

                socket.on('reconnect', (attempt) => {
                    console.log('âœ… é‡æ–°é€£æ¥æˆåŠŸ');
                    updateConnectionStatus('connected');
                    socket.emit('user_online', currentUser.id);
                });

                socket.on('reconnect_failed', () => {
                    console.error('âŒ é‡æ–°é€£æ¥å¤±æ•—');
                    updateConnectionStatus('failed');
                    alert('ç„¡æ³•é€£æ¥åˆ°èŠå¤©ä¼ºæœå™¨ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦');
                });

                // åŠ è¼‰æœƒè©±åˆ—è¡¨
                await loadSessions();
                
                // è¨­ç½®äº‹ä»¶ç›£è½å™¨
                setupEventListeners();
                
                // è‡ªå‹•é¸æ“‡URLä¸­çš„æœƒè©±
                await autoSelectSession();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–èŠå¤©ç³»çµ±éŒ¯èª¤:', error);
                alert('èŠå¤©ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        }

        // æ›´æ–°é€£æ¥ç‹€æ…‹
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus') || createConnectionStatusElement();
            
            const statusConfig = {
                'connected': { text: 'å·²é€£æ¥', color: '#4CAF50', icon: 'fa-check-circle' },
                'disconnected': { text: 'å·²æ–·é–‹', color: '#FF9800', icon: 'fa-exclamation-circle' },
                'error': { text: 'é€£æ¥éŒ¯èª¤', color: '#F44336', icon: 'fa-times-circle' },
                'reconnecting': { text: 'é‡æ–°é€£æ¥ä¸­...', color: '#FFC107', icon: 'fa-sync-alt' },
                'failed': { text: 'é€£æ¥å¤±æ•—', color: '#F44336', icon: 'fa-times-circle' }
            };
            
            const config = statusConfig[status] || statusConfig.disconnected;
            statusElement.innerHTML = `<i class="fas ${config.icon}"></i> ${config.text}`;
            statusElement.style.color = config.color;
        }

        // å‰µå»ºé€£æ¥ç‹€æ…‹å…ƒç´ 
        function createConnectionStatusElement() {
            const statusElement = document.createElement('div');
            statusElement.id = 'connectionStatus';
            statusElement.style.cssText = `
                position: fixed;
                top: 90px;
                right: 20px;
                background: white;
                padding: 8px 12px;
                border-radius: 20px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                font-size: 0.8rem;
                z-index: 1001;
                display: flex;
                align-items: center;
                gap: 5px;
            `;
            document.body.appendChild(statusElement);
            return statusElement;
        }

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // æ¶ˆæ¯è¼¸å…¥
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            if (messageInput && sendBtn) {
                messageInput.addEventListener('input', function() {
                    sendBtn.disabled = !this.value.trim() && !fileToSend;
                    autoResizeTextarea(this);
                });
                
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                sendBtn.addEventListener('click', sendMessage);
            }
            
            // æ–‡ä»¶é™„ä»¶
            const attachFileBtn = document.getElementById('attachFileBtn');
            const fileInput = document.getElementById('fileInput');
            
            if (attachFileBtn && fileInput) {
                attachFileBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            // ç§»å‹•ç«¯åˆ‡æ›
            const toggleSessions = document.getElementById('toggleSessions');
            if (toggleSessions) {
                toggleSessions.addEventListener('click', toggleMobileView);
            }
            
            // æœƒè©±æœç´¢
            const searchInput = document.getElementById('searchSessions');
            if (searchInput) {
                searchInput.addEventListener('input', filterSessions);
            }
        }

        // åŠ è¼‰æœƒè©±åˆ—è¡¨
        async function loadSessions() {
            try {
                const token = localStorage.getItem('token');
                console.log('ğŸ” åŠ è¼‰æœƒè©±åˆ—è¡¨...');
                
                const response = await fetch(`${API_BASE_URL}/chat/sessions`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                sessions = await response.json();
                console.log(`âœ… åŠ è¼‰ ${sessions.length} å€‹æœƒè©±`);
                renderSessionsList(sessions);
                
                // åŠ è¼‰æœªè®€æ¶ˆæ¯æ•¸é‡
                await loadUnreadCount();
                
            } catch (error) {
                console.error('âŒ åŠ è¼‰æœƒè©±åˆ—è¡¨éŒ¯èª¤:', error);
                showError('åŠ è¼‰æœƒè©±åˆ—è¡¨å¤±æ•—: ' + error.message);
            }
        }

        // ç™¼é€æ¶ˆæ¯ - ä¿®å¾©ç‰ˆæœ¬
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const messageText = messageInput?.value.trim();
            
            if (!messageText && !fileToSend) return;
            
            if (!socket || !socket.connected) {
                showError('æœªé€£æ¥åˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥');
                return;
            }
            
            if (!currentSession) {
                showError('è«‹å…ˆé¸æ“‡å°è©±');
                return;
            }
            
            try {
                let messageData = {
                    sessionId: currentSession.id,
                    message: messageText || '',
                    messageType: 'text'
                };
                
                // å¦‚æœæœ‰æ–‡ä»¶ï¼Œå…ˆä¸Šå‚³æ–‡ä»¶
                if (fileToSend) {
                    console.log('ğŸ“ ä¸Šå‚³æ–‡ä»¶:', fileToSend.name);
                    const formData = new FormData();
                    formData.append('file', fileToSend);
                    
                    const token = localStorage.getItem('token');
                    const uploadResponse = await fetch(`${API_BASE_URL}/chat/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error('æ–‡ä»¶ä¸Šå‚³å¤±æ•—: ' + uploadResponse.statusText);
                    }
                    
                    const fileInfo = await uploadResponse.json();
                    messageData.messageType = fileToSend.type.startsWith('image/') ? 'image' : 'file';
                    messageData.fileInfo = fileInfo;
                    messageData.message = messageText || fileInfo.name;
                    
                    console.log('âœ… æ–‡ä»¶ä¸Šå‚³æˆåŠŸ:', fileInfo);
                }
                
                // é€šéSocketç™¼é€æ¶ˆæ¯
                console.log('ğŸ“¤ ç™¼é€æ¶ˆæ¯:', messageData);
                socket.emit('send_message', messageData);
                
                // æ¸…ç©ºè¼¸å…¥
                if (messageInput) {
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                }
                clearFilePreview();
                document.getElementById('sendBtn').disabled = true;
                
            } catch (error) {
                console.error('âŒ ç™¼é€æ¶ˆæ¯éŒ¯èª¤:', error);
                showError('ç™¼é€æ¶ˆæ¯å¤±æ•—: ' + error.message);
            }
        }

        // è™•ç†æ–°æ¶ˆæ¯
        function handleNewMessage(message) {
            console.log('ğŸ“¥ æ”¶åˆ°æ–°æ¶ˆæ¯:', message);
            
            if (currentSession && message.session_id === currentSession.id) {
                const container = document.getElementById('messagesContainer');
                if (container) {
                    const messageElement = createMessageElement(message);
                    container.appendChild(messageElement);
                    scrollToBottom();
                    
                    // æ¨™è¨˜ç‚ºå·²è®€
                    markMessagesAsRead(currentSession.id);
                }
            }
            
            // æ›´æ–°æœƒè©±åˆ—è¡¨
            loadSessions();
        }

        // å·¥å…·å‡½æ•¸
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 24 * 60 * 60 * 1000) {
                    return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString('zh-TW');
                }
            } catch (error) {
                return '';
            }
        }

        function showError(message) {
            // ä½¿ç”¨æ›´å‹å¥½çš„éŒ¯èª¤æç¤º
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: #f44336;
                color: white;
                padding: 12px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 300px;
                text-align: center;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // å…¶ä»–ç¾æœ‰å‡½æ•¸ä¿æŒä¸è®Š...
        // handleFileSelect, clearFilePreview, markMessagesAsRead, ç­‰å‡½æ•¸...

        // æ¸¬è©¦é€£æ¥
        function testConnection() {
            console.log('ğŸ§ª æ¸¬è©¦é€£æ¥ç‹€æ…‹:');
            console.log('- Socket connected:', socket?.connected);
            console.log('- Current user:', currentUser);
            console.log('- Current session:', currentSession);
            console.log('- Sessions count:', sessions.length);
        }

        // åœ¨æ§åˆ¶å°æš´éœ²æ¸¬è©¦å‡½æ•¸
        window.testChatConnection = testConnection;
    </script>
</body>
</html>