<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡ˆä»¶è©³æƒ… - Happy Pet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f8f4ff 0%, #f0e6ff 100%);
            color: #5a4a6a;
            line-height: 1.6;
        }
        
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, #8a6db5 0%, #6b4e8e 100%);
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(107, 78, 142, 0.3);
            z-index: 1000;
        }
        
        .navbar-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar-logo {
            font-size: 1.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .navbar-logo i {
            margin-right: 10px;
            font-size: 1.5rem;
        }
        
        .case-detail-container {
            max-width: 1000px;
            margin: 100px auto 40px;
            padding: 20px;
        }
        
        .case-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(107, 78, 142, 0.1);
            margin-bottom: 30px;
        }
        
        .case-title {
            color: #6b4e8e;
            font-size: 2.2rem;
            margin-bottom: 15px;
        }
        
        .case-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #7f8c8d;
        }
        
        .case-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .photos-section, .details-section, .reviews-section, .caretaker-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(107, 78, 142, 0.1);
        }
        
        .main-photo {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #f8f4ff 0%, #f0e6ff 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .main-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-thumbnails {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .thumbnail {
            height: 80px;
            background: #f8f4ff;
            border-radius: 5px;
            cursor: pointer;
            overflow: hidden;
        }
        
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .detail-item {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .detail-label {
            font-weight: 600;
            color: #6b4e8e;
            margin-bottom: 5px;
        }
        
        .review-item {
            padding: 20px;
            border: 1px solid #ecf0f1;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .review-rating {
            color: #f39c12;
        }
        
        .add-review-form {
            background: #f8f4ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .star-rating {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .star {
            font-size: 1.5rem;
            color: #ddd;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .star:hover,
        .star.active {
            color: #f39c12;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #e6d9ff;
            border-radius: 5px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #8a6db5 0%, #6b4e8e 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(138, 109, 181, 0.4);
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-success { background: #e8f5e8; color: #27ae60; }
        .badge-warning { background: #fff3cd; color: #f39c12; }
        .badge-info { background: #e3f2fd; color: #3498db; }
        .badge-secondary { background: #f8f9fa; color: #6c757d; }
        
        .text-danger { color: #e74c3c; }
        
        /* å³ä¸‹è§’åº”è˜æŒ‰é’®æ ·å¼ */
        .apply-btn-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
        }
        
        .apply-btn {
            background: linear-gradient(135deg, #ff9a44 0%, #ff6b6b 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .apply-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.5);
        }
        
        /* æ¥æ¡ˆä¿å§†ä¿¡æ¯æ ·å¼ */
        .caretaker-section {
            margin-bottom: 30px;
        }
        
        .caretaker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .caretaker-info {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .caretaker-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f8f4ff 0%, #f0e6ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .caretaker-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .caretaker-details {
            flex: 1;
        }
        
        .caretaker-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #6b4e8e;
            margin-bottom: 5px;
        }
        
        .caretaker-rating {
            color: #f39c12;
            margin-bottom: 10px;
        }
        
        .caretaker-contact {
            background: #f8f4ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .contact-item:last-child {
            margin-bottom: 0;
        }
        
        .no-caretaker {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        @media (max-width: 768px) {
            .case-content {
                grid-template-columns: 1fr;
            }
            
            .case-title {
                font-size: 1.8rem;
            }
            
            .main-photo {
                height: 300px;
            }
            
            .photo-thumbnails {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .apply-btn-container {
                bottom: 20px;
                right: 20px;
            }
            
            .apply-btn {
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            .caretaker-info {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>

    
    <!-- å°èˆªæ¬„ -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-logo">
                <i class="fas fa-paw"></i> HAPPY PET
            </div>
            <ul style="display: flex; list-style: none; gap: 20px;">
                <li><a href="index.html" style="color: white; text-decoration: none;">è¿”å›é¦–é </a></li>
            </ul>
        </div>
    </nav>

    <div class="case-detail-container">
        <div id="caseDetailContent">
            <!-- æ¡ˆä»¶è©³æƒ…å…§å®¹æœƒç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
            <div style="text-align: center; padding: 50px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6b4e8e;"></i>
                <p style="margin-top: 20px;">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>

    
    <!-- å³ä¸‹è§’åº”è˜æŒ‰é’® -->
    <div class="apply-btn-container">
        <button class="btn apply-btn" id="applyBtn">
            <i class="fas fa-hand-paper"></i> æˆ‘è¦åº”è˜æ¥æ¡ˆ
        </button>
    </div>

    <button class="btn btn-primary" onclick="startChatWithOwner()">
    <i class="fas fa-comment"></i> è¯ç¹«é£¼ä¸»
</button>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let currentCaseId = null;
        let currentUser = null;
        let selectedRating = 0;

       // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // å¾ URL ç²å–æ¡ˆä»¶ ID
    const urlParams = new URLSearchParams(window.location.search);
    currentCaseId = urlParams.get('id');
    
    // æª¢æŸ¥ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹
    const token = localStorage.getItem('token');
    const user = localStorage.getItem('user');
    if (token && user) {
        currentUser = JSON.parse(user);
    }
    
    if (currentCaseId) {
        loadCaseDetail(currentCaseId);
    } else {
        document.getElementById('caseDetailContent').innerHTML = '<p style="text-align: center; padding: 50px;">æ¡ˆä»¶ä¸å­˜åœ¨</p>';
    }
    
    // ç»‘å®šåº”è˜æŒ‰é’®äº‹ä»¶
    document.getElementById('applyBtn').addEventListener('click', applyForCase);
});

       // è¼‰å…¥æ¡ˆä»¶è©³æƒ…
async function loadCaseDetail(caseId) {
    try {
        console.log('ğŸ”„ è¼‰å…¥æ¡ˆä»¶è©³æƒ…:', caseId);
        const response = await fetch(`${API_BASE_URL}/cases/${caseId}/detail`);
        
        if (!response.ok) {
            throw new Error('æ¡ˆä»¶ä¸å­˜åœ¨');
        }
        
        const caseDetail = await response.json();
        console.log('âœ… æ¡ˆä»¶è©³æƒ…è¼‰å…¥æˆåŠŸ:', caseDetail);
        
        // æ¸²æŸ“æ¡ˆä»¶è¯¦æƒ…
        renderCaseDetail(caseDetail);
        
        // åŠ è½½è¯„ä»·
        loadCaseReviews(caseId);
        
        // é‡è¦ï¼šæ£€æŸ¥å¹¶æ˜¾ç¤ºä¿å§†ä¿¡æ¯
        console.log('ğŸ” æ£€æŸ¥ä¿å§†ä¿¡æ¯...');
        checkCaretakerInfo(caseDetail);
        
    } catch (error) {
        console.error('âŒ è¼‰å…¥æ¡ˆä»¶è©³æƒ…éŒ¯èª¤:', error);
        document.getElementById('caseDetailContent').innerHTML = `
            <div style="text-align: center; padding: 50px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #e74c3c;"></i>
                <h2 style="color: #e74c3c; margin: 20px 0;">è¼‰å…¥å¤±æ•—</h2>
                <p>${error.message}</p>
                <button class="btn btn-primary" onclick="window.location.href='index.html'" style="margin-top: 20px;">
                    è¿”å›é¦–é 
                </button>
            </div>
        `;
    }
}

        // æ¸²æŸ“æ¡ˆä»¶è©³æƒ…
        function renderCaseDetail(caseDetail) {
            const content = `
                <div class="case-header">
                    <h1 class="case-title">${escapeHtml(caseDetail.title)}</h1>
                    <div class="case-meta">
                        <div class="meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${escapeHtml(caseDetail.location)}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-clock"></i>
                            <span>${new Date(caseDetail.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas fa-eye"></i>
                            <span>${caseDetail.view_count || 0} æ¬¡ç€è¦½</span>
                        </div>
                        <div class="meta-item">
                            <i class="fas ${caseDetail.is_urgent ? 'fa-exclamation-triangle text-danger' : 'fa-info-circle'}"></i>
                            <span>${getUrgencyText(caseDetail.urgency_level)}</span>
                        </div>
                    </div>
                    <p style="color: #7f8c8d; line-height: 1.6; font-size: 1.1rem;">${escapeHtml(caseDetail.description)}</p>
                </div>
                
                <div class="case-content">
                    <div class="photos-section">
                        <h3><i class="fas fa-images"></i> æ¡ˆä»¶ç…§ç‰‡</h3>
                        <div class="main-photo" id="mainPhoto">
                            ${caseDetail.photos && caseDetail.photos.length > 0 ? 
                                `<img src="${API_BASE_URL}/uploads/${caseDetail.photos[0].photo_url}" alt="æ¡ˆä»¶ç…§ç‰‡" onerror="handleImageError(this)">` :
                                '<div style="text-align: center;"><i class="fas fa-camera" style="font-size: 3rem; color: #6b4e8e;"></i><p style="margin-top: 10px;">æš«ç„¡ç…§ç‰‡</p></div>'
                            }
                        </div>
                        ${caseDetail.photos && caseDetail.photos.length > 1 ? `
                            <div class="photo-thumbnails">
                                ${caseDetail.photos.map((photo, index) => `
                                    <div class="thumbnail" onclick="changeMainPhoto('${photo.photo_url}')">
                                        <img src="${API_BASE_URL}/uploads/${photo.photo_url}" alt="ç¸®åœ–" onerror="handleImageError(this)">
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="details-section">
                        <h3><i class="fas fa-info-circle"></i> è©³ç´°è³‡è¨Š</h3>
                        <div class="detail-item">
                            <div class="detail-label">æ¡ˆä»¶é¡å‹</div>
                            <p>${escapeHtml(caseDetail.type_name || 'æœªåˆ†é¡')}</p>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">è¯çµ¡è³‡è¨Š</div>
                            <p>${escapeHtml(caseDetail.contact_info || 'æœªæä¾›')}</p>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">é ç®—</div>
                            <p>${caseDetail.budget ? `NT$ ${caseDetail.budget.toLocaleString()}` : 'é¢è­°'}</p>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">æ¡ˆä»¶ç‹€æ…‹</div>
                            <span class="badge ${getCaseStatusBadge(caseDetail.status)}">
                                ${getCaseStatusText(caseDetail.status)}
                            </span>
                        </div>
                        ${caseDetail.detailed_description ? `
                            <div class="detail-item">
                                <div class="detail-label">è©³ç´°æè¿°</div>
                                <p>${escapeHtml(caseDetail.detailed_description)}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- æ¥æ¡ˆä¿å§†ä¿¡æ¯åŒºåŸŸ -->
                <div class="caretaker-section" id="caretakerSection">
                    <!-- æ¥æ¡ˆä¿å§†ä¿¡æ¯ä¼šåŠ¨æ€åŠ è½½ -->
                </div>
                
                <div class="reviews-section">
                    <h3><i class="fas fa-star"></i> è©•åƒ¹èˆ‡è©•è«–</h3>
                    <div id="reviewsList">
                        <!-- è©•åƒ¹åˆ—è¡¨æœƒå‹•æ…‹è¼‰å…¥ -->
                    </div>
                    ${currentUser ? `
                        <div class="add-review-form">
                            <h4>ç™¼è¡¨è©•åƒ¹</h4>
                            <div class="star-rating" id="starRating">
                                ${[1,2,3,4,5].map(i => `<i class="fas fa-star star" data-rating="${i}"></i>`).join('')}
                            </div>
                            <textarea class="form-control" id="reviewComment" placeholder="è«‹è¼¸å…¥æ‚¨çš„è©•è«–..." rows="3"></textarea>
                            <button class="btn btn-primary" onclick="submitReview()">æäº¤è©•åƒ¹</button>
                        </div>
                    ` : '<p>è«‹å…ˆ<a href="index.html" style="color: #8a6db5;">ç™»å…¥</a>æ‰èƒ½ç™¼è¡¨è©•åƒ¹</p>'}
                </div>
            `;
            
            document.getElementById('caseDetailContent').innerHTML = content;
            setupStarRating();
        }

       /// æ£€æŸ¥æ¥æ¡ˆä¿å§†ä¿¡æ¯
function checkCaretakerInfo(caseDetail) {
    console.log('ğŸ” æ£€æŸ¥ä¿å§†ä¿¡æ¯ - å®Œæ•´æ¡ˆä»¶è¯¦æƒ…:', caseDetail);
    
    const applyBtn = document.getElementById('applyBtn');
    if (!applyBtn) {
        console.error('âŒ æ‰¾ä¸åˆ°åº”è˜æŒ‰é’®');
        return;
    }
    
    // è°ƒè¯•ä¿¡æ¯
    console.log('ğŸ“Š æ¡ˆä»¶å…³é”®ä¿¡æ¯:', {
        assigned_to: caseDetail.assigned_to,
        status: caseDetail.status,
        currentUser: currentUser ? currentUser.id : 'æœªç™»å½•',
        created_by: caseDetail.created_by
    });
    
    // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºåº”è˜æŒ‰é’®
    const shouldShowApplyBtn = currentUser && 
                              caseDetail.status === 'open' && 
                              caseDetail.created_by !== currentUser.id &&
                              (!caseDetail.assigned_to || caseDetail.assigned_to !== currentUser.id);
    
    console.log('æ˜¯å¦æ˜¾ç¤ºåº”è˜æŒ‰é’®:', shouldShowApplyBtn);
    
    if (shouldShowApplyBtn) {
        applyBtn.style.display = 'flex';
        console.log('ğŸŸ¢ æ˜¾ç¤ºåº”è˜æŒ‰é’®');
    } else {
        applyBtn.style.display = 'none';
        console.log('ğŸ”´ éšè—åº”è˜æŒ‰é’®');
    }
    
    // æ£€æŸ¥å¹¶æ˜¾ç¤ºä¿å§†ä¿¡æ¯
    const hasCaretaker = caseDetail.assigned_to;
    
    console.log('æ˜¯å¦æœ‰æ¥æ¡ˆä¿å§†:', hasCaretaker);
    
    if (hasCaretaker) {
        console.log('ğŸ‘¤ æ¡ˆä»¶æœ‰ä¿å§†ï¼ŒåŠ è½½ä¿å§†ä¿¡æ¯...');
        loadCaretakerInfo(caseDetail);
    } else {
        console.log('ğŸ‘¤ æ¡ˆä»¶æ²¡æœ‰ä¿å§†ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯');
        renderNoCaretaker();
    }
}



// åŠ è½½æ¥æ¡ˆä¿å§†ä¿¡æ¯
async function loadCaretakerInfo(caseDetail) {
    try {
        console.log(`ğŸ‘¤ ä»APIåŠ è½½æ¡ˆä»¶ ${caseDetail.id} çš„ä¿å§†ä¿¡æ¯`);
        
        const response = await fetch(`${API_BASE_URL}/cases/${caseDetail.id}/caretaker`);
        
        if (response.ok) {
            const caretaker = await response.json();
            console.log('âœ… è·å–åˆ°ä¿å§†ä¿¡æ¯ï¼Œæ•°æ®ç±»å‹æ£€æŸ¥:', {
                rating: { value: caretaker.rating, type: typeof caretaker.rating },
                review_count: { value: caretaker.review_count, type: typeof caretaker.review_count },
                completed_cases: { value: caretaker.completed_cases, type: typeof caretaker.completed_cases }
            });
            renderCaretakerInfo(caretaker);
        } else if (response.status === 404) {
            console.log('â„¹ï¸ APIè¿”å›404ï¼Œæ¡ˆä»¶æ²¡æœ‰ä¿å§†ä¿¡æ¯');
            renderNoCaretaker();
        } else {
            console.error('âŒ APIè¿”å›é”™è¯¯çŠ¶æ€:', response.status);
            throw new Error('è·å–ä¿å§†ä¿¡æ¯å¤±è´¥');
        }
        
    } catch (error) {
        console.error('âŒ åŠ è½½ä¿å§†ä¿¡æ¯é”™è¯¯:', error);
        renderNoCaretaker();
    }
}

// æ˜¾ç¤ºåŸºæœ¬ä¿å§†ä¿¡æ¯ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
function displayBasicCaretakerInfo(assignedTo) {
    const caretakerSection = document.getElementById('caretakerSection');
    if (!caretakerSection) return;
    
    caretakerSection.innerHTML = `
        <div class="caretaker-header">
            <h3><i class="fas fa-user-check"></i> æ¥æ¡ˆä¿å§†</h3>
            <span class="badge badge-success">å·²æ¥æ¡ˆ</span>
        </div>
        <div class="caretaker-info">
            <div class="caretaker-avatar">
                <i class="fas fa-user" style="font-size: 2rem; color: #6b4e8e;"></i>
            </div>
            <div class="caretaker-details">
                <div class="caretaker-name">æ¥æ¡ˆä¿å§† (ID: ${assignedTo})</div>
                <div class="caretaker-rating">
                    â˜…â˜…â˜…â˜…â˜…
                    <span style="color: #7f8c8d; margin-left: 5px;">5.0 (0 å‰‡è©•åƒ¹)</span>
                </div>
                <div style="margin: 10px 0; font-size: 0.9rem; color: #7f8c8d;">
                    <span>å·²å®Œæˆ 0 å€‹æ¡ˆä»¶</span>
                </div>
                <p>é€™ä½ä¿å§†å·²ç¶“æ¥æ¡ˆï¼Œè©³ç´°è³‡è¨ŠåŠ è¼‰ä¸­...</p>
            </div>
        </div>
        <div class="caretaker-contact">
            <h4 style="margin-bottom: 15px; color: #6b4e8e;">è¯çµ¡æ–¹å¼</h4>
            <div class="contact-item">
                <i class="fas fa-info-circle" style="color: #3498db;"></i>
                <span>è©³ç´°è¯çµ¡è³‡è¨ŠåŠ è¼‰ä¸­...</span>
            </div>
        </div>
    `;
}

        // æ¸²æŸ“æ²¡æœ‰æ¥æ¡ˆä¿å§†çš„çŠ¶æ€
function renderNoCaretaker() {
    const caretakerSection = document.getElementById('caretakerSection');
    if (!caretakerSection) {
        console.error('âŒ æ‰¾ä¸åˆ°caretakerSectionå…ƒç´ ');
        return;
    }
    
    console.log('ğŸ‘¤ æ¸²æŸ“æ— ä¿å§†çŠ¶æ€');
    
    caretakerSection.innerHTML = `
        <div class="no-caretaker">
            <i class="fas fa-user-clock" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <h3>å°šæœªæœ‰ä¿å§†æ¥æ¡ˆ</h3>
            <p>æˆç‚ºç¬¬ä¸€å€‹æ¥æ¡ˆçš„ä¿å§†å§ï¼</p>
        </div>
    `;
}

// æ¸²æŸ“æ¥æ¡ˆä¿å§†ä¿¡æ¯
function renderCaretakerInfo(caretaker) {
    const caretakerSection = document.getElementById('caretakerSection');
    if (!caretakerSection) {
        console.error('âŒ æ‰¾ä¸åˆ°caretakerSectionå…ƒç´ ');
        return;
    }
    
    console.log('ğŸ¨ æ¸²æŸ“ä¿å§†ä¿¡æ¯:', caretaker);
    
    // å®‰å…¨å¤„ç†è¯„åˆ†æ•°æ®
    let ratingValue = 0;
    let ratingDisplay = '0.0';
    
    try {
        // ç¡®ä¿ratingæ˜¯æ•°å­—
        ratingValue = parseFloat(caretaker.rating) || 0;
        ratingDisplay = ratingValue.toFixed(1);
        console.log('â­ å¤„ç†åçš„è¯„åˆ†:', { original: caretaker.rating, parsed: ratingValue, display: ratingDisplay });
    } catch (error) {
        console.error('âŒ è¯„åˆ†å¤„ç†é”™è¯¯:', error);
        ratingValue = 0;
        ratingDisplay = '0.0';
    }
    
    // å®‰å…¨å¤„ç†å…¶ä»–æ•°å­—å­—æ®µ
    const reviewCount = parseInt(caretaker.review_count) || 0;
    const completedCases = parseInt(caretaker.completed_cases) || 0;
    
    caretakerSection.innerHTML = `
        <div class="caretaker-header">
            <h3><i class="fas fa-user-check"></i> æ¥æ¡ˆä¿å§†</h3>
            <span class="badge badge-success">å·²æ¥æ¡ˆ</span>
        </div>
        <div class="caretaker-info">
            <div class="caretaker-avatar">
                ${caretaker.avatar ? 
                    `<img src="${API_BASE_URL}/uploads/${caretaker.avatar}" alt="${caretaker.name}" onerror="handleCaretakerImageError(this)">` :
                    `<i class="fas fa-user" style="font-size: 2rem; color: #6b4e8e;"></i>`
                }
            </div>
            <div class="caretaker-details">
                <div class="caretaker-name">${escapeHtml(caretaker.name)}</div>
                <div class="caretaker-rating">
                    ${'â˜…'.repeat(Math.floor(ratingValue))}${'â˜†'.repeat(5 - Math.floor(ratingValue))}
                    <span style="color: #7f8c8d; margin-left: 5px;">
                        ${ratingDisplay} (${reviewCount} å‰‡è©•åƒ¹)
                    </span>
                </div>
                <div style="margin: 10px 0; font-size: 0.9rem; color: #7f8c8d;">
                    <span>å·²å®Œæˆ ${completedCases} å€‹æ¡ˆä»¶</span>
                    <span style="margin: 0 10px">â€¢</span>
                    <span>æœƒå“¡ since ${caretaker.member_since || new Date().getFullYear()}</span>
                </div>
                <p>${escapeHtml(caretaker.bio || 'é€™ä½ä¿å§†é‚„æ²’æœ‰è‡ªæˆ‘ä»‹ç´¹')}</p>
            </div>
        </div>
        <div class="caretaker-contact">
            <h4 style="margin-bottom: 15px; color: #6b4e8e;">è¯çµ¡æ–¹å¼</h4>
            <div class="contact-item">
                <i class="fas fa-phone" style="color: #27ae60;"></i>
                <span>${escapeHtml(caretaker.phone || 'æœªæä¾›')}</span>
            </div>
            <div class="contact-item">
                <i class="fas fa-envelope" style="color: #3498db;"></i>
                <span>${escapeHtml(caretaker.email || 'æœªæä¾›')}</span>
            </div>
            <div class="contact-item">
                <i class="fas fa-map-marker-alt" style="color: #e74c3c;"></i>
                <span>${escapeHtml(caretaker.location || 'æœªæä¾›')}</span>
            </div>
        </div>
    `;
    
    console.log('âœ… ä¿å§†ä¿¡æ¯æ¸²æŸ“å®Œæˆ');
}
        // ä¿å§†å¤´åƒå›¾ç‰‡é”™è¯¯å¤„ç†
        function handleCaretakerImageError(img) {
            console.log('âŒ ä¿å§†å¤´åƒåŠ è¼‰å¤±æ•—:', img.src);
            const parent = img.parentNode;
            parent.innerHTML = '<i class="fas fa-user" style="font-size: 2rem; color: #6b4e8e;"></i>';
        }

// åº”è˜æ¥æ¡ˆ
async function applyForCase() {
    if (!currentUser) {
        alert('è«‹å…ˆç™»å…¥æ‰èƒ½æ‡‰è˜æ¥æ¡ˆ');
        return;
    }
    
    if (!confirm('ç¢ºå®šè¦æ‡‰è˜æ¥é€™å€‹æ¡ˆä»¶å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/cases/${currentCaseId}/apply`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('æ‡‰è˜æˆåŠŸï¼æ¡ˆä»¶ç™¼ä½ˆè€…å°‡æœƒèˆ‡æ‚¨è¯ç¹«ã€‚');
            
            console.log('âœ… åº”è˜æˆåŠŸï¼Œè¿”å›æ•°æ®:', result);
            
            // éšè—åº”è˜æŒ‰é’®
            document.getElementById('applyBtn').style.display = 'none';
            
            // é‡è¦ï¼šé‡æ–°åŠ è½½æ•´ä¸ªæ¡ˆä»¶è¯¦æƒ…é¡µé¢ï¼Œè·å–æœ€æ–°çš„ä¿å§†ä¿¡æ¯
            console.log('ğŸ”„ é‡æ–°åŠ è½½æ¡ˆä»¶è¯¦æƒ…...');
            await loadCaseDetail(currentCaseId);
            
        } else {
            const error = await response.json();
            alert('æ‡‰è˜å¤±æ•—: ' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
    } catch (error) {
        console.error('æ‡‰è˜æ¥æ¡ˆéŒ¯èª¤:', error);
        alert('æ‡‰è˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
}


async function startChatWithOwner() {
    try {
        const token = localStorage.getItem('token');
        const caseId = getCaseIdFromURL(); // ä»URLè·å–æ¡ˆä»¶ID
        
        // è·å–æ¡ˆä»¶ä¿¡æ¯ä»¥ç¡®å®šé¥²ä¸»ID
        const caseResponse = await fetch(`${API_BASE_URL}/cases/${caseId}/detail`);
        const caseData = await caseResponse.json();
        
        // åˆ›å»ºæˆ–è·å–èŠå¤©ä¼šè¯
        const chatResponse = await fetch(`${API_BASE_URL}/chat/sessions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                caseId: caseId,
                participant2Id: caseData.created_by
            })
        });
        
        const session = await chatResponse.json();
        
        // è·³è½¬åˆ°èŠå¤©é¡µé¢
        window.location.href = `chat.html?session=${session.id}`;
        
    } catch (error) {
        console.error('é–‹å§‹èŠå¤©éŒ¯èª¤:', error);
        alert('é–‹å§‹èŠå¤©å¤±æ•—');
    }
}



// æ˜¾ç¤ºå½“å‰ç”¨æˆ·ä½œä¸ºæ¥æ¡ˆä¿å§†
function displayCurrentUserAsCaretaker() {
    if (!currentUser) {
        console.error('âŒ å½“å‰ç”¨æˆ·ä¸å­˜åœ¨');
        return;
    }
    
    console.log('ğŸ‘¤ æ˜¾ç¤ºå½“å‰ç”¨æˆ·ä½œä¸ºæ¥æ¡ˆä¿å§†:', currentUser);
    
    const caretakerInfo = {
        id: currentUser.id,
        name: currentUser.full_name || currentUser.username,
        username: currentUser.username,
        email: currentUser.email || 'æœªæä¾›',
        phone: currentUser.phone || 'æœªæä¾›',
        location: currentUser.location || 'æœªæä¾›',
        avatar: null,
        rating: '5.0',
        review_count: 0,
        completed_cases: 0,
        member_since: new Date().getFullYear(),
        bio: 'æˆ‘æ˜¯ä¸€ä½ç†±å¿ƒçš„å¯µç‰©æ„›å¥½è€…ï¼Œé¡˜æ„å¹«åŠ©ç…§é¡§æ‚¨çš„å¯µç‰©ï¼'
    };
    
    renderCaretakerInfo(caretakerInfo);
}
    

        // æ¨¡æ‹Ÿä¿å§†åˆ†é…
        function simulateCaretakerAssignment() {
            const mockCaretaker = {
                name: currentUser.username,
                avatar: null,
                rating: 5,
                review_count: 0,
                completed_cases: 0,
                bio: 'æˆ‘æ˜¯æ–°åŠ å…¥çš„å¯µç‰©ä¿å§†ï¼Œå°ç…§é¡§å¯µç‰©å……æ»¿ç†±æƒ…ï¼',
                phone: 'æœªæä¾›',
                email: currentUser.email || 'æœªæä¾›',
                location: 'æœªæä¾›',
                member_since: new Date().getFullYear()
            };
            
            renderCaretakerInfo(mockCaretaker);
        }

        // ä¿®æ”¹åˆ‡æ¢ç…§ç‰‡å‡½æ•°
        function changeMainPhoto(photoUrl) {
            const mainPhoto = document.getElementById('mainPhoto');
            mainPhoto.innerHTML = `<img src="${API_BASE_URL}/uploads/${photoUrl}" alt="æ¡ˆä»¶ç…§ç‰‡" onerror="handleImageError(this)">`;
        }

        // æ·»åŠ å›¾ç‰‡é”™è¯¯å¤„ç†å‡½æ•°
        function handleImageError(img) {
            console.log('âŒ åœ–ç‰‡åŠ è¼‰å¤±æ•—:', img.src);
            const parent = img.parentNode;
            if (parent.querySelector('.default-icon')) return; // é¿å…é‡å¤æ·»åŠ 
            
            parent.innerHTML = `
                <div class="default-icon" style="text-align: center; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <i class="fas fa-camera" style="font-size: 3rem; color: #6b4e8e;"></i>
                    <p style="margin-top: 10px; color: #6b4e8e;">ç…§ç‰‡åŠ è¼‰å¤±æ•—</p>
                    <small style="color: #888; margin-top: 5px;">${img.src.split('/').pop()}</small>
                </div>
            `;
        }

        // è¨­å®šæ˜Ÿç´šè©•åˆ†
        function setupStarRating() {
            const stars = document.querySelectorAll('.star');
            selectedRating = 0;
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    stars.forEach(s => {
                        if (parseInt(s.dataset.rating) <= selectedRating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
        }

        // æäº¤è©•åƒ¹
        async function submitReview() {
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }
            
            const comment = document.getElementById('reviewComment').value;
            
            if (selectedRating === 0) {
                alert('è«‹é¸æ“‡è©•åˆ†');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/cases/${currentCaseId}/reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        rating: selectedRating,
                        comment: comment
                    })
                });
                
                if (response.ok) {
                    alert('è©•åƒ¹æäº¤æˆåŠŸï¼');
                    loadCaseReviews(currentCaseId);
                    // æ¸…ç©ºè¡¨å–®
                    document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
                    document.getElementById('reviewComment').value = '';
                    selectedRating = 0;
                } else {
                    const error = await response.json();
                    alert('è©•åƒ¹æäº¤å¤±æ•—: ' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                console.error('æäº¤è©•åƒ¹éŒ¯èª¤:', error);
                alert('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // è¼‰å…¥æ¡ˆä»¶è©•åƒ¹
        async function loadCaseReviews(caseId) {
            try {
                const response = await fetch(`${API_BASE_URL}/cases/${caseId}/reviews`);
                const reviews = await response.json();
                
                const reviewsList = document.getElementById('reviewsList');
                if (reviews.length === 0) {
                    reviewsList.innerHTML = '<p>å°šç„¡è©•åƒ¹</p>';
                    return;
                }
                
                reviewsList.innerHTML = reviews.map(review => `
                    <div class="review-item">
                        <div class="review-header">
                            <strong>${escapeHtml(review.username)}</strong>
                            <div class="review-rating">
                                ${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5 - review.rating)}
                            </div>
                        </div>
                        <p>${escapeHtml(review.comment || 'ç„¡è©•è«–å…§å®¹')}</p>
                        <small style="color: #7f8c8d;">${new Date(review.created_at).toLocaleDateString()}</small>
                    </div>
                `).join('');
            } catch (error) {
                console.error('è¼‰å…¥è©•åƒ¹éŒ¯èª¤:', error);
            }
        }

        // å·¥å…·å‡½æ•¸
        function getCaseStatusBadge(status) {
            const badges = {
                'open': 'badge-success',
                'in_progress': 'badge-warning',
                'completed': 'badge-info',
                'cancelled': 'badge-secondary'
            };
            return badges[status] || 'badge-secondary';
        }

        function getCaseStatusText(status) {
            const texts = {
                'open': 'é–‹å•Ÿ',
                'in_progress': 'è™•ç†ä¸­',
                'completed': 'å·²å®Œæˆ',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return texts[status] || status;
        }

        function getUrgencyText(urgency) {
            const texts = {
                'low': 'ä¸€èˆ¬',
                'medium': 'ä¸­ç­‰',
                'high': 'ç·Šæ€¥',
                'emergency': 'éå¸¸ç·Šæ€¥'
            };
            return texts[urgency] || urgency;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>